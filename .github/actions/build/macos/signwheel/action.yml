name: Sign Wheels
description: Unpack Sign Wheels and then RePack
runs:
  using: composite
  steps:
    - name: Unpack
      shell: sh
      run: |
        cd ./assets/python/wheels
        find . -name '*.whl' -exec sh -c 'unzip -d "${1%.*}" "$1"' _ {} \;
        find . -name "*.whl" -type f -delete
    - name: Gather
      shell: bash
      run: |
        echo $PATH
        which brew
        brew install bash
        cd ./assets/python/wheels
        mapfile -t bin_array < <(find . -name "*so" -o -name "*.dylib")
        declare -p bin_array
        echo bin_array
        echo "bins=toJSON(bin_array)" >> $GITHUB_OUTPUT
    - name: Sign
      shell: sh
      run: |
        echo ${{fromJSON(steps.vars.outputs.bins)}}
        for i in ${{ fromJSON(steps.vars.outputs.bins)}}; do --sign 6698D856280DC1662A8E01E5B63428CB6D6651BB --force --timestamp --options runtime --entitlements ./assets/entitlements.mac.plist "$i" ; done
    - name: Repack
      shell: sh
      run: |
        for i in */; do zip -r "${i%/}.whl" "$i"; done
